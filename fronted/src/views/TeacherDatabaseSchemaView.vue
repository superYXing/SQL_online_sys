<template>
  <div class="teacher-layout">
    <!-- щб╢щГихп╝шИкцаП -->
    <el-header class="header">
      <div class="header-left">
        <span class="logo" @click="goToHome">SQLхЬич║┐хоЮш╖╡х╣│хП░</span>
        <div class="nav-buttons">
          <el-button type="text" @click="goToDashboard" class="nav-btn">цХ░цНощЭвцЭ┐</el-button>
          <el-button type="text" @click="goToDatabaseSchema" class="nav-btn active"
            >цХ░цНох║Уцибх╝П</el-button
          >
          <el-button type="text" @click="goToProblem" class="nav-btn">щвШчЫо</el-button>
          <el-button type="text" @click="goToStudentInfo" class="nav-btn">хнжчФЯф┐бцБп</el-button>
        </div>
      </div>
      <div class="header-right">
        <el-dropdown @command="handleCommand" trigger="click">
          <span class="username-dropdown">
            {{ teacherInfo.teacher_name || 'хКаш╜╜ф╕н...' }}
            <el-icon class="el-icon--right"><arrow-down /></el-icon>
          </span>
          <template #dropdown>
            <el-dropdown-menu>
              <el-dropdown-item command="changePassword">ф┐оцФ╣хпЖчаБ</el-dropdown-item>
              <el-dropdown-item command="logout">щААхЗ║чЩ╗х╜Х</el-dropdown-item>
            </el-dropdown-menu>
          </template>
        </el-dropdown>
      </div>
    </el-header>

    <el-container class="main-container">
      <!-- ф╕╗хЖЕхо╣хМ║ -->
      <el-main class="main-content">
        <div class="schema-wrapper" :class="{ 'has-selection': selectedSchema }">
          <!-- х╖жф╛зя╝ЪцХ░цНох║Уцибх╝ПхИЧшби -->
          <div class="left-panel">
            <div class="panel-header">
              <div class="header-content">
                <div class="header-title">
                  <el-button type="text" @click="goBack" class="back-btn">
                    <el-icon><ArrowLeft /></el-icon>
                  </el-button>
                  <h3 class="title-with-spacing">
                    <el-icon><DataAnalysis /></el-icon> цХ░цНох║Уцибх╝П
                  </h3>
                </div>
                <el-button type="primary" @click="showCreateDialog" class="create-btn">
                  <el-icon><Plus /></el-icon>
                  хИЫх╗║цибх╝П
                </el-button>
              </div>
            </div>
            <div class="schema-list">
              <div
                v-for="schema in schemaList"
                :key="schema.schema_name"
                class="schema-item"
                :class="{ active: selectedSchema === schema.schema_name }"
                @click="selectSchema(schema)"
              >
                <div class="schema-content">
                  <div class="schema-name">{{ schema.schema_name }}</div>
                  <div class="schema-author">{{ schema.schema_author }}</div>
                  <!-- цХ░цНох║Уцибх╝ПчК╢цАБф┐бцБп -->
                  <div class="schema-visibility">
                    <el-tag :type="getVisibilityTagType(schema.schema_status || 0)" size="small">
                      {{ getVisibilityText(schema.schema_status || 0) }}
                    </el-tag>
                  </div>
                </div>
                <div class="schema-actions">
                  <el-button
                    type="danger"
                    size="small"
                    @click.stop="deleteSchema(schema)"
                    :loading="deleteLoading === schema.schema_id"
                  >
                    <el-icon><Delete /></el-icon>
                    хИащЩд
                  </el-button>
                </div>
              </div>
            </div>

            <!-- чК╢цАБф┐бцБпшп┤цШО -->
            <div class="visibility-info">
              <h4>ЁЯУЛ цХ░цНох║Уцибх╝ПчК╢цАБшп┤цШО</h4>
              <div class="visibility-options">
                <div class="visibility-option">
                  <el-radio v-model="schemaStatus" :label="1"> хоМхЕихПпшзБ </el-radio>
                  <p class="option-desc">
                    хнжчФЯхПпф╗еф╜┐чФицХ░цНох║Уцибх╝ПчЪДщвШчЫоя╝Мф╣ЯхПпф╗еф╜┐чФицХ░цНох║Уцибх╝ПчЪДцЯешпвхКЯшГ╜уАВ
                  </p>
                </div>
                <div class="visibility-option">
                  <el-radio v-model="schemaStatus" :label="0"> ф╕НхПпшзБ </el-radio>
                  <p class="option-desc">цХ░цНох║Уцибх╝Пхп╣хнжчФЯщАПцШОуАВ</p>
                </div>
              </div>
              <div class="status-actions">
                <el-button
                  type="primary"
                  @click="updateSchemaStatus"
                  :loading="statusLoading"
                  class="confirm-btn"
                >
                  чбошодшо╛ч╜о
                </el-button>
              </div>
            </div>
          </div>

          <!-- ф╕нщЧ┤я╝ЪщАЙщб╣шбихНХя╝ИщАЙцЛйцибх╝ПхРОцШ╛чд║я╝Й -->
          <div class="middle-panel" v-if="selectedSchema">
            <div class="panel-header">
              <h3>
                <el-icon><Setting /></el-icon> цХ░цНох║Уцибх╝ПцУНф╜Ь
              </h3>
            </div>
            <div class="option-buttons">
              <el-button
                :type="activeTab === 'basic' ? 'primary' : 'default'"
                @click="activeTab = 'basic'"
                class="option-btn"
              >
                хЯ║цЬмф┐бцБп
              </el-button>
              <el-button
                :type="activeTab === 'query' ? 'primary' : 'default'"
                @click="activeTab = 'query'"
                class="option-btn"
              >
                цЯешпвщЭвцЭ┐
              </el-button>
              <el-button
                :type="activeTab === 'tables' ? 'primary' : 'default'"
                @click="activeTab = 'tables'"
                class="option-btn"
              >
                цХ░цНошби
              </el-button>
              <el-button
                :type="activeTab === 'views' ? 'primary' : 'default'"
                @click="activeTab = 'views'"
                class="option-btn"
              >
                шзЖхЫ╛
              </el-button>
            </div>
          </div>

          <!-- хП│ф╛зя╝ЪхЖЕхо╣щЭвцЭ┐я╝ИщАЙцЛйцибх╝ПхРОцШ╛чд║я╝Й -->
          <div class="right-panel" v-if="selectedSchema">
            <!-- хЯ║цЬмф┐бцБп -->
            <div v-if="activeTab === 'basic'" class="content-panel">
              <div class="panel-header">
                <h3>
                  <el-icon><Document /></el-icon> хЯ║цЬмф┐бцБп
                </h3>
                <div class="header-actions">
                  <el-button v-if="!isEditMode" type="primary" @click="enterEditMode">
                    <el-icon><Edit /></el-icon>
                    ч╝Цш╛Сцибх╝П
                  </el-button>
                  <div v-else class="edit-actions">
                    <el-button @click="cancelEdit">хПЦц╢И</el-button>
                    <el-button type="primary" @click="saveChanges" :loading="editLoading">
                      <el-icon><Check /></el-icon>
                      ф┐ЭхнШф┐оцФ╣
                    </el-button>
                  </div>
                </div>
              </div>
              <div class="basic-info-content">
                <div class="schema-header">
                  <h2 v-if="!isEditMode">{{ selectedSchemaInfo.schema_name }}</h2>
                  <el-input
                    v-else
                    v-model="editForm.schema_name"
                    placeholder="цХ░цНох║Уцибх╝ПхРНчз░"
                    class="schema-name-input"
                  />
                  <p class="author">ф╜ЬшАЕя╝Ъ{{ selectedSchemaInfo.schema_author }}</p>
                </div>

                <!-- цХ░цНох║Уцибх╝ПцППш┐░ -->
                <div class="schema-description">
                  <h4>ЁЯУЭ цХ░цНох║Уцибх╝ПцППш┐░</h4>
                  <div v-if="!isEditMode" class="description-viewer expanded">
                    <div
                      v-html="selectedSchemaInfo.schema_description || getDefaultDescription()"
                    ></div>
                    <el-pagination
                      v-if="false"
                      v-model:current-page="currentPage"
                      :page-size="pageSize"
                      :total="1000"
                      layout="prev, pager, next"
                      class="description-pagination"
                    />
                  </div>
                  <div v-else class="description-editor">
                    <div class="html-editor-header">
                      <div class="editor-tabs">
                        <el-button
                          :type="editHtmlViewMode === 'edit' ? 'primary' : 'default'"
                          @click="editHtmlViewMode = 'edit'"
                          size="small"
                        >
                          <el-icon><Edit /></el-icon>
                          ч╝Цш╛С
                        </el-button>
                        <el-button
                          :type="editHtmlViewMode === 'preview' ? 'primary' : 'default'"
                          @click="editHtmlViewMode = 'preview'"
                          size="small"
                        >
                          <el-icon><View /></el-icon>
                          щвДшзИ
                        </el-button>
                        <el-button
                          :type="editHtmlViewMode === 'split' ? 'primary' : 'default'"
                          @click="editHtmlViewMode = 'split'"
                          size="small"
                        >
                          <el-icon><Grid /></el-icon>
                          хИЖцаП
                        </el-button>
                      </div>
                    </div>
                    <div class="html-editor-content" :class="`mode-${editHtmlViewMode}`">
                      <!-- ч╝Цш╛Сцибх╝П -->
                      <div v-if="editHtmlViewMode === 'edit'" class="editor-panel full">
                        <el-input
                          v-model="editForm.html_content"
                          type="textarea"
                          :rows="20"
                          placeholder="шп╖ш╛УхЕеHTMLф╗гчаБ..."
                          class="html-code-editor"
                        />
                      </div>
                      <!-- щвДшзИцибх╝П -->
                      <div v-else-if="editHtmlViewMode === 'preview'" class="preview-panel full">
                        <div
                          class="html-preview"
                          v-html="editForm.html_content || '<p>цЪВцЧахЖЕхо╣</p>'"
                        ></div>
                      </div>
                      <!-- хИЖцаПцибх╝П -->
                      <div v-else class="split-view">
                        <div class="editor-panel half">
                          <div class="panel-title">HTMLф╗гчаБ</div>
                          <el-input
                            v-model="editForm.html_content"
                            type="textarea"
                            :rows="18"
                            placeholder="шп╖ш╛УхЕеHTMLф╗гчаБ..."
                            class="html-code-editor"
                          />
                        </div>
                        <div class="preview-panel half">
                          <div class="panel-title">щвДшзИцХИцЮЬ</div>
                          <div
                            class="html-preview"
                            v-html="editForm.html_content || '<p>цЪВцЧахЖЕхо╣</p>'"
                          ></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ч╝Цш╛Сцибх╝Пф╕ЛчЪДщвЭхдЦщЕНч╜о -->
                <div v-if="isEditMode" class="edit-config">
                  <div class="config-item">
                    <h4>ЁЯУЛ SQLцибх╝ПхРНчз░</h4>
                    <el-input v-model="editForm.sql_schema" placeholder="шп╖ш╛УхЕеSQLцибх╝ПхРНчз░" />
                  </div>
                  <div class="config-item">
                    <h4>ЁЯУБ цЫ┤цЦ░MySQLх╗║шбицЦЗф╗╢я╝ИхПпщАЙя╝Й</h4>
                    <el-upload
                      :before-upload="(file) => handleEditFileChange(file, 'mysql')"
                      :show-file-list="true"
                      :limit="1"
                      accept=".sql"
                      drag
                      class="sql-file-upload"
                    >
                      <el-icon class="el-icon--upload"><Upload /></el-icon>
                      <div class="el-upload__text">
                        х░ЖMySQL SQLцЦЗф╗╢цЛЦхИ░цндхдДя╝МцИЦ<em>чВ╣хЗ╗ф╕Кф╝а</em>
                      </div>
                      <template #tip>
                        <div class="el-upload__tip">
                          хПкшГ╜ф╕Кф╝а.sqlцЦЗф╗╢я╝Мф╕Фф╕Нш╢Еш┐З10MBуАВхжВф╕Нф╕Кф╝ахИЩф┐ЭцМБхОЯцЬЙцЦЗф╗╢ф╕НхПШуАВ
                        </div>
                      </template>
                    </el-upload>

                    <!-- MySQLцЦЗф╗╢хЖЕхо╣цШ╛чд║ -->
                    <div
                      v-if="editMysqlFileContent"
                      class="sql-content-display"
                      style="margin-top: 10px"
                    >
                      <el-input
                        v-model="editMysqlFileContent"
                        type="textarea"
                        :rows="4"
                        readonly
                        placeholder="MySQL SQLцЦЗф╗╢хЖЕхо╣"
                        class="sql-content-textarea"
                      />
                    </div>
                  </div>

                  <div class="config-item">
                    <h4>ЁЯУБ цЫ┤цЦ░PostgreSQL/OpenGaussх╗║шбицЦЗф╗╢я╝ИхПпщАЙя╝Й</h4>
                    <el-upload
                      :before-upload="(file) => handleEditFileChange(file, 'postgresql')"
                      :show-file-list="true"
                      :limit="1"
                      accept=".sql"
                      drag
                      class="sql-file-upload"
                    >
                      <el-icon class="el-icon--upload"><Upload /></el-icon>
                      <div class="el-upload__text">
                        х░ЖPostgreSQL/OpenGauss SQLцЦЗф╗╢цЛЦхИ░цндхдДя╝МцИЦ<em>чВ╣хЗ╗ф╕Кф╝а</em>
                      </div>
                      <template #tip>
                        <div class="el-upload__tip">
                          хПкшГ╜ф╕Кф╝а.sqlцЦЗф╗╢я╝Мф╕Фф╕Нш╢Еш┐З10MBуАВхжВф╕Нф╕Кф╝ахИЩф┐ЭцМБхОЯцЬЙцЦЗф╗╢ф╕НхПШуАВ
                        </div>
                      </template>
                    </el-upload>

                    <!-- PostgreSQLцЦЗф╗╢хЖЕхо╣цШ╛чд║ -->
                    <div
                      v-if="editPostgresqlFileContent"
                      class="sql-content-display"
                      style="margin-top: 10px"
                    >
                      <el-input
                        v-model="editPostgresqlFileContent"
                        type="textarea"
                        :rows="4"
                        readonly
                        placeholder="PostgreSQL/OpenGauss SQLцЦЗф╗╢хЖЕхо╣"
                        class="sql-content-textarea"
                      />
                    </div>
                  </div>
                </div>

                <!-- цХ░цНох║Уцибх╝ПчК╢цАБшп┤цШО -->
                <div class="visibility-info">
                  <h4>ЁЯУЛ цХ░цНох║Уцибх╝ПчК╢цАБшп┤цШО</h4>
                  <div class="visibility-options">
                    <div class="visibility-option">
                      <el-tag type="success" size="small">хоМхЕихПпшзБ</el-tag>
                      <p class="option-desc">
                        хнжчФЯхПпф╗еф╜┐чФицХ░цНох║Уцибх╝ПчЪДщвШчЫоя╝Мф╣ЯхПпф╗еф╜┐чФицХ░цНох║Уцибх╝ПчЪДцЯешпвхКЯшГ╜уАВ
                      </p>
                    </div>
                    <div class="visibility-option">
                      <el-tag type="danger" size="small">ф╕НхПпшзБ</el-tag>
                      <p class="option-desc">цХ░цНох║Уцибх╝Пхп╣хнжчФЯщАПцШОуАВ</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- цЯешпвщЭвцЭ┐ -->
            <div v-if="activeTab === 'query'" class="content-panel">
              <div class="panel-header">
                <h3>
                  <el-icon><Search /></el-icon> SQLцУНф╜Ья╝ИхЕищГицЭГщЩРя╝Йя╝Иpgsqlх╝ХцУОя╝Й
                </h3>
                <div class="query-actions">
                  <el-button type="primary" @click="executeQuery" :loading="queryLoading">
                    <el-icon><Search /></el-icon>
                    цЯешпв
                  </el-button>
                  <el-button @click="clearQuery">
                    <el-icon><Delete /></el-icon>
                    ц╕Ечй║
                  </el-button>
                </div>
              </div>

              <div class="query-content">
                <!-- SQLч╝Цш╛СхЩи -->
                <div class="sql-editor">
                  <el-input
                    v-model="sqlQuery"
                    type="textarea"
                    :rows="6"
                    placeholder="шп╖ш╛УхЕеSQLшпнхПея╝Мф╛ЛхжВя╝ЪSELECT * FROM EMPLOYEES"
                    class="sql-textarea"
                  />
                </div>

                <!-- цЯешпвч╗УцЮЬшбица╝ -->
                <div class="results-section">
                  <div class="results-header">
                    <h4>
                      <el-icon><Grid /></el-icon> цЯешпвч╗УцЮЬ
                    </h4>
                    <div class="results-info" v-if="queryResults.length > 0">
                      хЕ▒ {{ queryResults.length }} цЭбшо░х╜Х
                    </div>
                  </div>

                  <div v-if="queryResults.length === 0 && !queryLoading" class="no-results">
                    <el-empty description="цЪВцЧацЯешпвч╗УцЮЬя╝Мшп╖цЙзшбМSQLцЯешпв" />
                  </div>

                  <div v-else class="results-table" v-loading="queryLoading">
                    <el-table
                      :data="queryResults"
                      border
                      stripe
                      height="400"
                      class="query-table"
                      :header-cell-style="{ background: '#409eff', color: '#fff' }"
                    >
                      <el-table-column
                        v-for="column in queryColumns"
                        :key="column"
                        :prop="column"
                        :label="column"
                        min-width="120"
                        show-overflow-tooltip
                      />
                    </el-table>
                  </div>
                </div>
              </div>
            </div>

            <!-- цХ░цНошби -->
            <div v-if="activeTab === 'tables'" class="content-panel">
              <div class="panel-header">
                <h3>
                  <el-icon><Grid /></el-icon> цХ░цНошби
                </h3>
              </div>
              <div class="placeholder-content">
                <el-empty description="цХ░цНошбихКЯшГ╜х╝АхПСф╕н..." />
              </div>
            </div>

            <!-- шзЖхЫ╛ -->
            <div v-if="activeTab === 'views'" class="content-panel">
              <div class="panel-header">
                <h3>
                  <el-icon><View /></el-icon> шзЖхЫ╛
                </h3>
              </div>
              <div class="placeholder-content">
                <el-empty description="шзЖхЫ╛хКЯшГ╜х╝АхПСф╕н..." />
              </div>
            </div>
          </div>
        </div>
      </el-main>
    </el-container>

    <!-- ф┐оцФ╣хпЖчаБхп╣шпЭцбЖ -->
    <el-dialog v-model="passwordDialogVisible" title="ф┐оцФ╣хпЖчаБ" width="400px">
      <el-form
        :model="passwordForm"
        :rules="passwordRules"
        ref="passwordFormRef"
        label-width="100px"
      >
        <el-form-item label="хОЯхпЖчаБ" prop="oldPassword">
          <el-input v-model="passwordForm.oldPassword" type="password" show-password />
        </el-form-item>
        <el-form-item label="цЦ░хпЖчаБ" prop="newPassword">
          <el-input v-model="passwordForm.newPassword" type="password" show-password />
        </el-form-item>
        <el-form-item label="чбошодхпЖчаБ" prop="confirmPassword">
          <el-input v-model="passwordForm.confirmPassword" type="password" show-password />
        </el-form-item>
      </el-form>
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="passwordDialogVisible = false">хПЦц╢И</el-button>
          <el-button type="primary" @click="changePassword">чбошод</el-button>
        </div>
      </template>
    </el-dialog>

    <!-- хИЫх╗║цХ░цНох║Уцибх╝Пхп╣шпЭцбЖ -->
    <el-dialog
      v-model="createDialogVisible"
      title="хИЫх╗║цХ░цНох║Уцибх╝П"
      width="900px"
      class="create-schema-dialog"
    >
      <el-form :model="createForm" :rules="createRules" ref="createFormRef" label-width="120px">
        <el-form-item label="цибх╝ПхРНчз░" prop="schema_name">
          <el-input v-model="createForm.schema_name" placeholder="шп╖ш╛УхЕецХ░цНох║Уцибх╝ПхРНчз░" />
        </el-form-item>

        <el-form-item label="SQLцибх╝ПхРНчз░" prop="sql_schema">
          <el-input v-model="createForm.sql_schema" placeholder="шп╖ш╛УхЕеSQLцибх╝ПхРНчз░" />
        </el-form-item>

        <el-form-item label="MySQLх╗║шбицЦЗф╗╢" required>
          <el-upload
            :before-upload="(file) => handleFileChange(file, 'mysql')"
            :show-file-list="true"
            :limit="1"
            accept=".sql"
            drag
            class="sql-file-upload"
          >
            <el-icon class="el-icon--upload"><Upload /></el-icon>
            <div class="el-upload__text">х░ЖMySQL SQLцЦЗф╗╢цЛЦхИ░цндхдДя╝МцИЦ<em>чВ╣хЗ╗ф╕Кф╝а</em></div>
            <template #tip>
              <div class="el-upload__tip">хПкшГ╜ф╕Кф╝а.sqlцЦЗф╗╢я╝Мф╕Фф╕Нш╢Еш┐З10MB</div>
            </template>
          </el-upload>
        </el-form-item>

        <!-- MySQL SQLцЦЗф╗╢хЖЕхо╣цШ╛чд║хМ║хЯЯ -->
        <el-form-item label="MySQLцЦЗф╗╢хЖЕхо╣" v-if="mysqlFileContent">
          <div class="sql-content-display">
            <el-input
              v-model="mysqlFileContent"
              type="textarea"
              :rows="6"
              readonly
              placeholder="MySQL SQLцЦЗф╗╢хЖЕхо╣х░ЖхЬицндцШ╛чд║"
              class="sql-content-textarea"
            />
          </div>
        </el-form-item>

        <el-form-item label="PostgreSQL/OpenGaussх╗║шбицЦЗф╗╢" required>
          <el-upload
            :before-upload="(file) => handleFileChange(file, 'postgresql')"
            :show-file-list="true"
            :limit="1"
            accept=".sql"
            drag
            class="sql-file-upload"
          >
            <el-icon class="el-icon--upload"><Upload /></el-icon>
            <div class="el-upload__text">
              х░ЖPostgreSQL/OpenGauss SQLцЦЗф╗╢цЛЦхИ░цндхдДя╝МцИЦ<em>чВ╣хЗ╗ф╕Кф╝а</em>
            </div>
            <template #tip>
              <div class="el-upload__tip">хПкшГ╜ф╕Кф╝а.sqlцЦЗф╗╢я╝Мф╕Фф╕Нш╢Еш┐З10MB</div>
            </template>
          </el-upload>
        </el-form-item>

        <!-- PostgreSQL SQLцЦЗф╗╢хЖЕхо╣цШ╛чд║хМ║хЯЯ -->
        <el-form-item label="PostgreSQLцЦЗф╗╢хЖЕхо╣" v-if="postgresqlFileContent">
          <div class="sql-content-display">
            <el-input
              v-model="postgresqlFileContent"
              type="textarea"
              :rows="6"
              readonly
              placeholder="PostgreSQL/OpenGauss SQLцЦЗф╗╢хЖЕхо╣х░ЖхЬицндцШ╛чд║"
              class="sql-content-textarea"
            />
          </div>
        </el-form-item>

        <el-form-item label="цибх╝ПцППш┐░" prop="html_content">
          <div class="html-editor-container">
            <div class="html-editor-header">
              <div class="editor-tabs">
                <el-button
                  :type="createHtmlViewMode === 'edit' ? 'primary' : 'default'"
                  @click="createHtmlViewMode = 'edit'"
                  size="small"
                >
                  <el-icon><Edit /></el-icon>
                  ч╝Цш╛С
                </el-button>
                <el-button
                  :type="createHtmlViewMode === 'preview' ? 'primary' : 'default'"
                  @click="createHtmlViewMode = 'preview'"
                  size="small"
                >
                  <el-icon><View /></el-icon>
                  щвДшзИ
                </el-button>
                <el-button
                  :type="createHtmlViewMode === 'split' ? 'primary' : 'default'"
                  @click="createHtmlViewMode = 'split'"
                  size="small"
                >
                  <el-icon><Grid /></el-icon>
                  хИЖцаП
                </el-button>
              </div>
            </div>
            <div class="html-editor-content" :class="`mode-${createHtmlViewMode}`">
              <!-- ч╝Цш╛Сцибх╝П -->
              <div v-if="createHtmlViewMode === 'edit'" class="editor-panel full">
                <el-input
                  v-model="createForm.html_content"
                  type="textarea"
                  :rows="15"
                  placeholder="шп╖ш╛УхЕеHTMLф╗гчаБ..."
                  class="html-code-editor"
                />
              </div>
              <!-- щвДшзИцибх╝П -->
              <div v-else-if="createHtmlViewMode === 'preview'" class="preview-panel full">
                <div
                  class="html-preview"
                  v-html="createForm.html_content || '<p>цЪВцЧахЖЕхо╣</p>'"
                ></div>
              </div>
              <!-- хИЖцаПцибх╝П -->
              <div v-else class="split-view">
                <div class="editor-panel half">
                  <div class="panel-title">HTMLф╗гчаБ</div>
                  <el-input
                    v-model="createForm.html_content"
                    type="textarea"
                    :rows="13"
                    placeholder="шп╖ш╛УхЕеHTMLф╗гчаБ..."
                    class="html-code-editor"
                  />
                </div>
                <div class="preview-panel half">
                  <div class="panel-title">щвДшзИцХИцЮЬ</div>
                  <div
                    class="html-preview"
                    v-html="createForm.html_content || '<p>цЪВцЧахЖЕхо╣</p>'"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </el-form-item>
      </el-form>

      <template #footer>
        <div class="dialog-footer">
          <el-button @click="createDialogVisible = false">хПЦц╢И</el-button>
          <el-button type="primary" @click="createSchema" :loading="createLoading">
            хИЫх╗║цибх╝П
          </el-button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  ArrowDown,
  ArrowLeft,
  Plus,
  DataAnalysis,
  Search,
  Delete,
  Grid,
  Document,
  Setting,
  View,
  Upload,
  Edit,
  Check,
} from '@element-plus/icons-vue'
import axios from '@/utils/axios'

const router = useRouter()

// хУНх║Фх╝ПцХ░цНо
const teacherInfo = ref<any>({})
const schemaList = ref<any[]>([])
const selectedSchema = ref<string>('')
const selectedSchemaInfo = ref<any>(null)
const activeTab = ref('basic')
const sqlQuery = ref('SELECT * FROM EMPLOYEES')
const queryResults = ref<any[]>([])
const queryColumns = ref<string[]>([])
const queryHistory = ref<any[]>([])

const schemaStatus = ref<number>(1) // 1: хоМхЕихПпшзБ, 0: ф╕НхПпшзБ
const statusLoading = ref(false)

// ч╝Цш╛Сцибх╝ПчЫ╕хЕ│
const isEditMode = ref(false)
const editHtmlViewMode = ref('edit') // 'edit', 'preview', 'split'
const editForm = ref({
  schema_id: 0,
  html_content: '',
  schema_name: '',
  mysql_file: null as File | null,
  postgresql_file: null as File | null,
  sql_schema: '',
})
const editFormRef = ref()
const editLoading = ref(false)
const editMysqlFileContent = ref('')
const editPostgresqlFileContent = ref('')
const currentPage = ref(1)
const pageSize = ref(1000) // шо╛ч╜ош╛ГхдзхА╝ф╗ецШ╛чд║хоМцХ┤хЖЕхо╣

// хИЫх╗║цХ░цНох║Уцибх╝Пхп╣шпЭцбЖ
const createDialogVisible = ref(false)
const createHtmlViewMode = ref('edit') // 'edit', 'preview', 'split'
const createForm = ref({
  html_content: '',
  schema_name: '',
  mysql_file: null as File | null,
  postgresql_file: null as File | null,
  sql_schema: '',
})
const createFormRef = ref()
const createLoading = ref(false)
const mysqlFileContent = ref('')
const postgresqlFileContent = ref('')

// хКаш╜╜чК╢цАБ
const queryLoading = ref(false)
const deleteLoading = ref<number | null>(null)

// хп╣шпЭцбЖчЫ╕хЕ│
const passwordDialogVisible = ref(false)

// шбихНХцХ░цНо
const passwordForm = ref({
  oldPassword: '',
  newPassword: '',
  confirmPassword: '',
})

// шбихНХх╝ХчФи
const passwordFormRef = ref()

// шбихНХщкМшпБшзДхИЩ
const passwordRules = {
  oldPassword: [{ required: true, message: 'шп╖ш╛УхЕехОЯхпЖчаБ', trigger: 'blur' }],
  newPassword: [
    { required: true, message: 'шп╖ш╛УхЕецЦ░хпЖчаБ', trigger: 'blur' },
    { min: 6, message: 'хпЖчаБщХ┐х║жф╕НшГ╜х░Сф║О6ф╜Н', trigger: 'blur' },
  ],
  confirmPassword: [
    { required: true, message: 'шп╖чбошодцЦ░хпЖчаБ', trigger: 'blur' },
    {
      validator: (rule: any, value: any, callback: any) => {
        if (value !== passwordForm.value.newPassword) {
          callback(new Error('ф╕дцмбш╛УхЕечЪДхпЖчаБф╕Нф╕АшЗ┤'))
        } else {
          callback()
        }
      },
      trigger: 'blur',
    },
  ],
}

// хИЫх╗║цХ░цНох║Уцибх╝ПшбихНХщкМшпБшзДхИЩ
const createRules = {
  schema_name: [
    { required: true, message: 'шп╖ш╛УхЕецХ░цНох║Уцибх╝ПхРНчз░', trigger: 'blur' },
    { min: 2, max: 50, message: 'хРНчз░щХ┐х║жхЬи 2 хИ░ 50 ф╕кхнЧчмж', trigger: 'blur' },
  ],
  sql_schema: [{ required: true, message: 'шп╖ш╛УхЕеSQLцибх╝ПхРНчз░', trigger: 'blur' }],
  html_content: [{ required: true, message: 'шп╖ш╛УхЕеHTMLхЖЕхо╣', trigger: 'blur' }],
}

// чФЯхС╜хСицЬЯ
onMounted(() => {
  fetchTeacherInfo()
  fetchSchemaList()
})

// шО╖хПЦцХЩх╕Иф┐бцБп
const fetchTeacherInfo = async () => {
  try {
    const response = await axios.get('/teacher/profile')
    if (response.data) {
      teacherInfo.value = response.data
    }
  } catch (error) {
    console.error('шО╖хПЦцХЩх╕Иф┐бцБпхд▒ш┤е:', error)
    ElMessage.error('шО╖хПЦцХЩх╕Иф┐бцБпхд▒ш┤е')
  }
}

// шО╖хПЦцХ░цНох║Уцибх╝ПхИЧшби
const fetchSchemaList = async () => {
  try {
    const response = await axios.get('/public/schema/list')
    if (response.data && Array.isArray(response.data)) {
      schemaList.value = response.data.map((schema) => ({
        ...schema,
        schema_id: schema.schema_id || 1, // чбоф┐ЭцЬЙschema_id
      }))
    }
  } catch (error) {
    console.error('шО╖хПЦцХ░цНох║Уцибх╝ПхИЧшбихд▒ш┤е:', error)
    ElMessage.error('шО╖хПЦцХ░цНох║Уцибх╝ПхИЧшбихд▒ш┤е')
  }
}

// щАЙцЛйцХ░цНох║Уцибх╝П
const selectSchema = (schema: any) => {
  selectedSchema.value = schema.schema_name
  selectedSchemaInfo.value = schema
  activeTab.value = 'basic' // щ╗ШшодщАЙцЛйхЯ║цЬмф┐бцБп
  // ц╕Ечй║цЯешпвч╗УцЮЬ
  queryResults.value = []
  queryColumns.value = []
  // ца╣цНох╜УхЙНцибх╝ПчЪДчК╢цАБхИЭхзЛхМЦschemaStatus
  // ф╜┐чФихРОчлпш┐ФхЫЮчЪДschema_statusхнЧцо╡я╝И0ф╕║ф╕НхПпшзБя╝М1ф╕║хПпшзБя╝Й
  schemaStatus.value = schema.schema_status || 0
}

// шО╖хПЦщАЙф╕нцибх╝ПчЪДschema_id
const getSchemaId = (schemaName: string) => {
  // ш┐ЩщЗМщЬАшжБца╣цНохоЮщЩЕцГЕхЖ╡шО╖хПЦschema_id
  // хПпшГ╜щЬАшжБф╗ОAPIшО╖хПЦцИЦшАЕч╗┤цКдф╕Аф╕кцШах░ДхЕ│ч│╗
  const schema = schemaList.value.find((s) => s.schema_name === schemaName)
  return schema ? schema.schema_id || 1 : 1 // щ╗Шшодш┐ФхЫЮ1
}

// шО╖хПЦщ╗ШшодцППш┐░хЖЕхо╣
const getDefaultDescription = () => {
  return `
    <div style="padding: 20px; line-height: 1.6;">
      <h3 style="color: #409eff; margin-bottom: 16px;">Oracle HR цХ░цНох║Уцибх╝П</h3>
      <p style="margin-bottom: 12px;">ш┐ЩцШпOracleцХ░цНох║УчЪДч╗ПхЕ╕HRя╝Иф║║хКЫш╡Дц║Ря╝Йчд║ф╛Лцибх╝Пя╝МхМЕхРлф║ЖхоМцХ┤чЪДхСШх╖ечобчРЖч│╗ч╗ЯцХ░цНоч╗УцЮДуАВ</p>

      <h4 style="color: #606266; margin: 16px 0 8px 0;">ф╕╗шжБцХ░цНошбия╝Ъ</h4>
      <ul style="margin: 0; padding-left: 20px;">
        <li style="margin-bottom: 8px;"><strong>EMPLOYEES</strong> - хСШх╖еф┐бцБпшбия╝МхМЕхРлхСШх╖ехЯ║цЬмф┐бцБпуАБшЦкш╡ДуАБщГищЧичнЙ</li>
        <li style="margin-bottom: 8px;"><strong>DEPARTMENTS</strong> - щГищЧиф┐бцБпшбия╝МхнШхВихЕмхП╕хРДщГищЧишпжч╗Жф┐бцБп</li>
        <li style="margin-bottom: 8px;"><strong>JOBS</strong> - шБМф╜Нф┐бцБпшбия╝МхоЪф╣ЙхРДчзНх╖еф╜Ьх▓Чф╜Н</li>
        <li style="margin-bottom: 8px;"><strong>LOCATIONS</strong> - хЬ░чРЖф╜Нч╜ошбия╝МхнШхВихКЮхЕмхЬ░чВ╣ф┐бцБп</li>
        <li style="margin-bottom: 8px;"><strong>COUNTRIES</strong> - хЫ╜хо╢ф┐бцБпшби</li>
        <li style="margin-bottom: 8px;"><strong>REGIONS</strong> - хЬ░хМ║ф┐бцБпшби</li>
      </ul>

      <h4 style="color: #606266; margin: 16px 0 8px 0;">цХ░цНочЙ╣чВ╣я╝Ъ</h4>
      <ul style="margin: 0; padding-left: 20px;">
        <li style="margin-bottom: 8px;">хМЕхРлхоМцХ┤чЪДхСШх╖ех▒Вч║зхЕ│ч│╗я╝Ич╗ПчРЖ-ф╕Лх▒Юя╝Й</li>
        <li style="margin-bottom: 8px;">цФпцМБхдЪщГищЧиуАБхдЪхЬ░хМ║чЪДч╗Дч╗ЗцЮ╢цЮД</li>
        <li style="margin-bottom: 8px;">хМЕхРлшЦкш╡ДхОЖхП▓хТМшБМф╜НхПШцЫ┤шо░х╜Х</li>
        <li style="margin-bottom: 8px;">щАВхРИхнжф╣аSQLцЯешпвуАБш┐ЮцОеуАБшБЪхРИчнЙцУНф╜Ь</li>
      </ul>

      <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-top: 16px;">
        <strong style="color: #409eff;">ЁЯТб цПРчд║я╝Ъ</strong>
        <span style="color: #606266;">ш┐Щф╕кцХ░цНох║Уцибх╝ПщЭЮх╕╕щАВхРИч╗Гф╣ахдНцЭВчЪДSQLцЯешпвя╝МхМЕцЛмхдЪшбиш┐ЮцОеуАБхнРцЯешпвуАБшБЪхРИхЗ╜цХ░чнЙщлШч║зчЙ╣цАзуАВ</span>
      </div>
    </div>
  `
}

// цЙзшбМSQLцЯешпв
const executeQuery = async () => {
  if (!sqlQuery.value.trim()) {
    ElMessage.warning('шп╖ш╛УхЕеSQLшпнхПе')
    return
  }

  if (!selectedSchema.value) {
    ElMessage.warning('шп╖хЕИщАЙцЛйцХ░цНох║Уцибх╝П')
    return
  }

  queryLoading.value = true
  try {
    const schemaId = getSchemaId(selectedSchema.value)
    const response = await axios.post('/teacher/schema/query', {
      schema_id: schemaId,
      sql: sqlQuery.value,
    })

    if (response.data.code === 200) {
      queryColumns.value = response.data.columns || []

      // ш╜мцНвшбМцХ░цНоф╕║хп╣ш▒бцХ░ч╗Д
      const rows = response.data.rows || []
      queryResults.value = rows.map((row: any[]) => {
        const obj: any = {}
        queryColumns.value.forEach((col, index) => {
          obj[col] = row[index]
        })
        return obj
      })

      // ц╖╗хКахИ░цЯешпвхОЖхП▓
      queryHistory.value.unshift({
        sql: sqlQuery.value,
        time: new Date().toLocaleString(),
      })

      // щЩРхИ╢хОЖхП▓шо░х╜ХцХ░щЗП
      if (queryHistory.value.length > 10) {
        queryHistory.value = queryHistory.value.slice(0, 10)
      }

      ElMessage.success('цЯешпвцИРхКЯ')
    } else {
      ElMessage.error(response.data.msg || 'цЯешпвхд▒ш┤е')
    }
  } catch (error) {
    console.error('цЯешпвхд▒ш┤е:', error)
    ElMessage.error('цЯешпвхд▒ш┤е')
  } finally {
    queryLoading.value = false
  }
}

// ц╕Ечй║цЯешпв
const clearQuery = () => {
  sqlQuery.value = ''
}

// хКаш╜╜хОЖхП▓цЯешпв
const loadHistoryQuery = (history: any) => {
  sqlQuery.value = history.sql
}

// хп╝шИкхЗ╜цХ░
const goToHome = () => {
  router.push('/teacher/home')
}

const goToDashboard = () => {
  router.push('/teacher/dashboard')
}

const goToDatabaseSchema = () => {
  // х╜УхЙНщб╡щЭвя╝Мф╕НщЬАшжБш╖│ш╜м
}

const goToProblem = () => {
  router.push('/teacher/problem')
}

const goToStudentInfo = () => {
  router.push('/teacher/student-info')
}

// хдДчРЖф╕ЛцЛЙшПЬхНХхС╜ф╗д
const handleCommand = (command: string) => {
  if (command === 'changePassword') {
    passwordDialogVisible.value = true
  } else if (command === 'logout') {
    handleLogout()
  }
}

// ф┐оцФ╣хпЖчаБ
const changePassword = async () => {
  if (!passwordFormRef.value) return

  try {
    await passwordFormRef.value.validate()

    const response = await axios.put('/teacher/change-password', {
      old_password: passwordForm.value.oldPassword,
      new_password: passwordForm.value.newPassword,
    })

    if (response.data && response.data.code === 200) {
      ElMessage.success('хпЖчаБф┐оцФ╣цИРхКЯ')
      passwordDialogVisible.value = false
      passwordForm.value = {
        oldPassword: '',
        newPassword: '',
        confirmPassword: '',
      }
    } else {
      ElMessage.error(response.data?.msg || 'хпЖчаБф┐оцФ╣хд▒ш┤е')
    }
  } catch (error) {
    console.error('ф┐оцФ╣хпЖчаБхд▒ш┤е:', error)
    ElMessage.error('ф┐оцФ╣хпЖчаБхд▒ш┤е')
  }
}

// щААхЗ║чЩ╗х╜Х
const handleLogout = () => {
  localStorage.removeItem('token')
  localStorage.removeItem('userInfo')
  ElMessage.success('х╖▓щААхЗ║чЩ╗х╜Х')
  router.push('/login')
}

// хЫЮщААхИ░ф╕Кф╕Ащб╡
const goBack = () => {
  router.go(-1)
}

// цЫ┤цЦ░цХ░цНох║Уцибх╝ПчК╢цАБ
const updateSchemaStatus = async () => {
  if (!selectedSchemaInfo.value) {
    ElMessage.warning('шп╖хЕИщАЙцЛйцХ░цНох║Уцибх╝П')
    return
  }

  try {
    statusLoading.value = true

    const response = await axios.put('/teacher/schema-status', {
      schema_id: selectedSchemaInfo.value.schema_id,
      status: schemaStatus.value,
    })

    if (response.data && response.data.code === 200) {
      ElMessage.success(response.data.message || 'цЭГщЩРшо╛ч╜оцИРхКЯ')
      // щЗНцЦ░шО╖хПЦцибх╝ПхИЧшбиф╗ецЫ┤цЦ░чК╢цАБцШ╛чд║
      await fetchSchemaList()
    } else {
      ElMessage.error(response.data?.message || 'цЭГщЩРшо╛ч╜охд▒ш┤е')
    }
  } catch (error) {
    console.error('шо╛ч╜оцХ░цНох║Уцибх╝ПцЭГщЩРхд▒ш┤е:', error)
    ElMessage.error('шо╛ч╜оцХ░цНох║Уцибх╝ПцЭГщЩРхд▒ш┤е')
  } finally {
    statusLoading.value = false
  }
}

// цШ╛чд║хИЫх╗║цХ░цНох║Уцибх╝Пхп╣шпЭцбЖ
const showCreateDialog = () => {
  createDialogVisible.value = true
  // щЗНч╜ошбихНХ
  createForm.value = {
    html_content: '',
    schema_name: '',
    mysql_file: null,
    postgresql_file: null,
    sql_schema: '',
  }
  mysqlFileContent.value = ''
  postgresqlFileContent.value = ''
}

// хдДчРЖцЦЗф╗╢ф╕Кф╝а
const handleFileChange = (file: File, type: 'mysql' | 'postgresql') => {
  if (type === 'mysql') {
    createForm.value.mysql_file = file

    // шп╗хПЦMySQLцЦЗф╗╢хЖЕхо╣х╣╢цШ╛чд║
    const reader = new FileReader()
    reader.onload = (e) => {
      mysqlFileContent.value = e.target?.result as string
    }
    reader.onerror = () => {
      ElMessage.error('MySQLцЦЗф╗╢шп╗хПЦхд▒ш┤е')
    }
    reader.readAsText(file)
  } else if (type === 'postgresql') {
    createForm.value.postgresql_file = file

    // шп╗хПЦPostgreSQLцЦЗф╗╢хЖЕхо╣х╣╢цШ╛чд║
    const reader = new FileReader()
    reader.onload = (e) => {
      postgresqlFileContent.value = e.target?.result as string
    }
    reader.onerror = () => {
      ElMessage.error('PostgreSQLцЦЗф╗╢шп╗хПЦхд▒ш┤е')
    }
    reader.readAsText(file)
  }

  return false // щШ╗цнвшЗкхКиф╕Кф╝а
}

// хдДчРЖч╝Цш╛Сцибх╝ПцЦЗф╗╢ф╕Кф╝а
const handleEditFileChange = (file: File, type: 'mysql' | 'postgresql') => {
  if (type === 'mysql') {
    editForm.value.mysql_file = file

    // шп╗хПЦMySQLцЦЗф╗╢хЖЕхо╣х╣╢цШ╛чд║
    const reader = new FileReader()
    reader.onload = (e) => {
      editMysqlFileContent.value = e.target?.result as string
    }
    reader.onerror = () => {
      ElMessage.error('MySQLцЦЗф╗╢шп╗хПЦхд▒ш┤е')
    }
    reader.readAsText(file)
  } else if (type === 'postgresql') {
    editForm.value.postgresql_file = file

    // шп╗хПЦPostgreSQLцЦЗф╗╢хЖЕхо╣х╣╢цШ╛чд║
    const reader = new FileReader()
    reader.onload = (e) => {
      editPostgresqlFileContent.value = e.target?.result as string
    }
    reader.onerror = () => {
      ElMessage.error('PostgreSQLцЦЗф╗╢шп╗хПЦхд▒ш┤е')
    }
    reader.readAsText(file)
  }

  return false // щШ╗цнвшЗкхКиф╕Кф╝а
}

// хИЫх╗║цХ░цНох║Уцибх╝П
const createSchema = async () => {
  if (!createFormRef.value) return

  try {
    await createFormRef.value.validate()

    // цгАцЯецШпхРжф╕Кф╝аф║Жф╕дф╕кцЦЗф╗╢
    if (!createForm.value.mysql_file) {
      ElMessage.error('шп╖ф╕Кф╝аMySQLх╗║шбицЦЗф╗╢')
      return
    }
    if (!createForm.value.postgresql_file) {
      ElMessage.error('шп╖ф╕Кф╝аPostgreSQL/OpenGaussх╗║шбицЦЗф╗╢')
      return
    }

    createLoading.value = true

    // шп╗хПЦMySQLцЦЗф╗╢хЖЕхо╣ф╕║хнЧчмжф╕▓
    const mysqlFileContent = await new Promise<string>((resolve, reject) => {
      const reader = new FileReader()
      reader.onload = (e) => {
        resolve(e.target?.result as string)
      }
      reader.onerror = reject
      reader.readAsText(createForm.value.mysql_file!)
    })

    // шп╗хПЦPostgreSQLцЦЗф╗╢хЖЕхо╣ф╕║хнЧчмжф╕▓
    const postgresqlFileContent = await new Promise<string>((resolve, reject) => {
      const reader = new FileReader()
      reader.onload = (e) => {
        resolve(e.target?.result as string)
      }
      reader.onerror = reject
      reader.readAsText(createForm.value.postgresql_file!)
    })

    const requestData = {
      schema_description: createForm.value.html_content,
      schema_name: createForm.value.schema_name,
      sql_file_content: {
        mysql_engine: mysqlFileContent,
        postgresql_opengauss_engine: postgresqlFileContent,
      },
      sql_schema: createForm.value.sql_schema,
      schema_author: teacherInfo.value.teacher_name || '',
    }

    const response = await axios.post('/teacher/schema/create', requestData, {
      headers: {
        'Content-Type': 'application/json',
      },
    })

    if (response.data && response.data.code === 200) {
      ElMessage.success('цХ░цНох║Уцибх╝ПхИЫх╗║цИРхКЯ')
      createDialogVisible.value = false
      // щЗНцЦ░шО╖хПЦцибх╝ПхИЧшби
      await fetchSchemaList()
    } else {
      ElMessage.error(response.data?.msg || 'хИЫх╗║хд▒ш┤е')
    }
  } catch (error) {
    console.error('хИЫх╗║цХ░цНох║Уцибх╝Пхд▒ш┤е:', error)
    ElMessage.error('хИЫх╗║цХ░цНох║Уцибх╝Пхд▒ш┤е')
  } finally {
    createLoading.value = false
  }
}

// шО╖хПЦхПпшзБцАзцаЗчн╛ч▒╗хЮЛ
const getVisibilityTagType = (status: number) => {
  return status === 1 ? 'success' : 'danger'
}

// шО╖хПЦхПпшзБцАзцЦЗцЬм
const getVisibilityText = (status: number) => {
  return status === 1 ? 'хоМхЕихПпшзБ' : 'ф╕НхПпшзБ'
}

// шО╖хПЦцХ░цНох║Уч▒╗хЮЛцаЗчн╛щвЬшЙ▓

// ш┐ЫхЕеч╝Цш╛Сцибх╝П
const enterEditMode = () => {
  if (!selectedSchemaInfo.value) return

  isEditMode.value = true
  editForm.value = {
    schema_id: selectedSchemaInfo.value.schema_id,
    html_content: selectedSchemaInfo.value.schema_description || '', // хКаш╜╜хоМцХ┤чЪДHTMLхЖЕхо╣я╝Мф╕НхО╗щЩдф╗╗ф╜ХцаЗчн╛
    schema_name: selectedSchemaInfo.value.schema_name,
    mysql_file: null,
    postgresql_file: null,
    sql_schema: selectedSchemaInfo.value.schema_name, // щ╗Шшодф╜┐чФиschema_name
  }
  // щЗНч╜оцЦЗф╗╢хЖЕхо╣цШ╛чд║
  editMysqlFileContent.value = ''
  editPostgresqlFileContent.value = ''
}

// хПЦц╢Ич╝Цш╛С
const cancelEdit = () => {
  isEditMode.value = false
  editForm.value = {
    schema_id: 0,
    html_content: '',
    schema_name: '',
    mysql_file: null,
    postgresql_file: null,
    sql_schema: '',
  }
  // щЗНч╜оцЦЗф╗╢хЖЕхо╣цШ╛чд║
  editMysqlFileContent.value = ''
  editPostgresqlFileContent.value = ''
}

// ф┐ЭхнШф┐оцФ╣я╝ИхЕИхИащЩдхЖНхИЫх╗║я╝Й
const saveChanges = async () => {
  if (!selectedSchemaInfo.value) return

  try {
    // цгАцЯецШпхРжф╕Кф╝аф║Жф╕дф╕кцЦЗф╗╢я╝ИхжВцЮЬшжБцЫ┤цЦ░SQLцЦЗф╗╢чЪДшпЭя╝Й
    const hasNewFiles = editForm.value.mysql_file || editForm.value.postgresql_file
    if (hasNewFiles && (!editForm.value.mysql_file || !editForm.value.postgresql_file)) {
      ElMessage.error('хжВцЮЬшжБцЫ┤цЦ░SQLцЦЗф╗╢я╝Мшп╖хРМцЧ╢ф╕Кф╝аMySQLхТМPostgreSQL/OpenGaussф╕дчзНцЦЗф╗╢')
      return
    }

    editLoading.value = true

    // чммф╕Ацнея╝ЪхИащЩдхОЯцЬЙцибх╝П
    const deleteResponse = await axios.delete(`/teacher/schemas/${editForm.value.schema_id}`)

    if (!deleteResponse.data || !deleteResponse.data.success) {
      ElMessage.error('хИащЩдхОЯцибх╝Пхд▒ш┤е')
      return
    }

    // чммф║Мцнея╝ЪхЗЖхдЗхИЫх╗║цЦ░цибх╝ПчЪДцХ░цНо
    let sqlFileContent: any

    if (hasNewFiles) {
      // хжВцЮЬцЬЙцЦ░цЦЗф╗╢я╝Мшп╗хПЦцЦ░цЦЗф╗╢хЖЕхо╣
      const mysqlContent = await new Promise<string>((resolve, reject) => {
        const reader = new FileReader()
        reader.onload = (e) => resolve(e.target?.result as string)
        reader.onerror = reject
        reader.readAsText(editForm.value.mysql_file!)
      })

      const postgresqlContent = await new Promise<string>((resolve, reject) => {
        const reader = new FileReader()
        reader.onload = (e) => resolve(e.target?.result as string)
        reader.onerror = reject
        reader.readAsText(editForm.value.postgresql_file!)
      })

      sqlFileContent = {
        mysql_engine: mysqlContent,
        postgresql_opengauss_engine: postgresqlContent,
      }
    } else {
      // хжВцЮЬц▓бцЬЙцЦ░цЦЗф╗╢я╝Мф╜┐чФихОЯцЬЙчЪДцЦЗф╗╢хЖЕхо╣я╝Иш┐ЩщЗМщЬАшжБф╗ОхОЯцибх╝Пф╕ншО╖хПЦя╝Й
      // ц│ицДПя╝Ъш┐ЩщЗМхБЗшо╛хОЯцибх╝ПчЪДSQLцЦЗф╗╢хЖЕхо╣хПпф╗еф╗ОцЯРф╕кхЬ░цЦ╣шО╖хПЦ
      // хоЮщЩЕхоЮчО░ф╕нхПпшГ╜щЬАшжБхЕИшО╖хПЦхОЯцибх╝ПчЪДхоМцХ┤ф┐бцБп
      ElMessage.warning('цЬкф╕Кф╝ацЦ░чЪДSQLцЦЗф╗╢я╝Мх░Жф┐ЭцМБхОЯцЬЙцЦЗф╗╢ф╕НхПШ')
      // ш┐ЩщЗМхПпшГ╜щЬАшжБш░ГчФиAPIшО╖хПЦхОЯцЬЙчЪДSQLцЦЗф╗╢хЖЕхо╣
      // ф╕║ф║ЖчоАхМЦя╝МцИСф╗мшжБц▒ВчФицИ╖х┐Ещб╗ф╕Кф╝ацЦ░цЦЗф╗╢
      ElMessage.error('ч╝Цш╛Сцибх╝Пф╕Лх┐Ещб╗щЗНцЦ░ф╕Кф╝аSQLцЦЗф╗╢')
      return
    }

    // чммф╕Йцнея╝ЪхИЫх╗║цЦ░цибх╝П
    const createData = {
      schema_description: editForm.value.html_content,
      schema_name: editForm.value.schema_name,
      sql_file_content: sqlFileContent,
      sql_schema: editForm.value.sql_schema,
      schema_author: teacherInfo.value.teacher_name || '',
    }

    const createResponse = await axios.post('/teacher/schema/create', createData, {
      headers: {
        'Content-Type': 'application/json',
      },
    })

    if (createResponse.data && createResponse.data.code === 200) {
      ElMessage.success('цХ░цНох║Уцибх╝Пф┐оцФ╣цИРхКЯ')

      // щААхЗ║ч╝Цш╛Сцибх╝П
      isEditMode.value = false

      // ц╕Ечй║щАЙф╕нчК╢цАБя╝МхЫаф╕║хОЯцибх╝Пх╖▓швлхИащЩд
      selectedSchema.value = ''
      selectedSchemaInfo.value = null

      // щЗНцЦ░шО╖хПЦцибх╝ПхИЧшби
      await fetchSchemaList()
    } else {
      ElMessage.error(createResponse.data?.msg || 'хИЫх╗║цЦ░цибх╝Пхд▒ш┤е')
    }
  } catch (error) {
    console.error('ф┐оцФ╣цХ░цНох║Уцибх╝Пхд▒ш┤е:', error)
    ElMessage.error('ф┐оцФ╣цХ░цНох║Уцибх╝Пхд▒ш┤е')
  } finally {
    editLoading.value = false
  }
}

// хИащЩдцХ░цНох║Уцибх╝П
const deleteSchema = async (schema: any) => {
  try {
    await ElMessageBox.confirm(
      `чбохоЪшжБхИащЩдцХ░цНох║Уцибх╝П "${schema.schema_name}" хРЧя╝Я\n\nц│ицДПя╝ЪхжВцЮЬшпецибх╝Пф╕ЛхнШхЬищвШчЫоя╝МщЬАшжБхЕИхИащЩдцЙАцЬЙчЫ╕хЕ│щвШчЫоуАВ`,
      'хИащЩдчбошод',
      {
        confirmButtonText: 'чбохоЪхИащЩд',
        cancelButtonText: 'хПЦц╢И',
        type: 'warning',
        dangerouslyUseHTMLString: true,
      },
    )

    deleteLoading.value = schema.schema_id

    const response = await axios.delete(`/teacher/schemas/${schema.schema_id}`)

    if (response.data && response.data.success) {
      ElMessage.success(response.data.message || 'цХ░цНох║Уцибх╝ПхИащЩдцИРхКЯ')

      // хжВцЮЬхИащЩдчЪДцШпх╜УхЙНщАЙф╕нчЪДцибх╝Пя╝Мц╕Ечй║щАЙф╕нчК╢цАБ
      if (selectedSchema.value === schema.schema_name) {
        selectedSchema.value = ''
        selectedSchemaInfo.value = null
      }

      // щЗНцЦ░шО╖хПЦцибх╝ПхИЧшби
      await fetchSchemaList()
    } else {
      ElMessage.error(response.data?.message || 'хИащЩдхд▒ш┤е')
    }
  } catch (error: any) {
    if (error !== 'cancel') {
      console.error('хИащЩдцХ░цНох║Уцибх╝Пхд▒ш┤е:', error)
      ElMessage.error('хИащЩдцХ░цНох║Уцибх╝Пхд▒ш┤е')
    }
  } finally {
    deleteLoading.value = null
  }
}
</script>

<style scoped>
.teacher-layout {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  overflow: hidden;
  background-color: #f5f7fa;
}

/* щб╢щГихп╝шИкцаП */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #545c64;
  padding: 0 24px;
  height: 64px;
  color: white;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.header-left {
  display: flex;
  align-items: center;
}

.nav-buttons {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-left: 30px;
}

.nav-btn {
  margin-left: 24px;
  font-size: 16px;
  color: #ffffff;
  font-weight: 500;
  transition: color 0.3s;
}

.nav-btn:hover {
  color: #cce5ff;
}

.nav-btn.active {
  color: #409eff;
  font-weight: 600;
}

.logo {
  font-size: 22px;
  font-weight: 600;
  color: #ffffff;
  cursor: pointer;
}

.logo:hover {
  opacity: 0.8;
}

.header-right {
  display: flex;
  align-items: center;
}

.username-dropdown {
  cursor: pointer;
  color: #ffffff;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.username-dropdown:hover {
  color: #cce5ff;
}

/* ф╕╗хо╣хЩи */
.main-container {
  flex: 1;
  overflow: hidden;
}

.main-content {
  padding: 0;
  height: 100%;
  overflow: hidden;
}

/* ф╗╗хКбхМЕшгЕхЩи */
.schema-wrapper {
  display: grid;
  grid-template-columns: 250px;
  height: 100%;
  gap: 0;
}

.schema-wrapper.has-selection {
  grid-template-columns: 250px 200px 1fr;
}

/* щЭвцЭ┐ца╖х╝П */
.left-panel,
.middle-panel,
.right-panel {
  background-color: #ffffff;
  border-right: 1px solid #e4e7ed;
  overflow-y: auto;
  height: 100%;
}

.right-panel {
  border-right: none;
}

.panel-header {
  padding: 20px;
  border-bottom: 1px solid #e4e7ed;
  background-color: #f8f9fa;
}

.header-content {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.panel-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #303133;
  display: flex;
  align-items: center;
  gap: 8px;
}

.title-with-spacing {
  letter-spacing: 2px;
  white-space: nowrap;
}

.header-title {
  display: flex;
  align-items: center;
  gap: 8px;
}

.back-btn {
  color: #606266;
  font-size: 18px;
  padding: 4px;
}

.back-btn:hover {
  color: #409eff;
}

.create-btn {
  font-size: 14px;
  padding: 8px 16px;
}

/* цХ░цНох║Уцибх╝ПхИЧшби */
.schema-list {
  padding: 16px;
}

.schema-item {
  padding: 12px 16px;
  margin-bottom: 8px;
  border: 1px solid #e4e7ed;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  background-color: #ffffff;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.schema-item:hover {
  border-color: #409eff;
  box-shadow: 0 2px 8px rgba(64, 158, 255, 0.1);
}

.schema-item.active {
  border-color: #409eff;
  background-color: #ecf5ff;
}

.schema-name {
  font-weight: 600;
  color: #303133;
  margin-bottom: 4px;
}

.schema-author {
  font-size: 12px;
  color: #909399;
}

.schema-content {
  flex: 1;
}

.schema-actions {
  margin-left: 12px;
}

.schema-visibility {
  margin-top: 8px;
}

/* чК╢цАБф┐бцБпшп┤цШО */
.visibility-info {
  padding: 16px;
  border-top: 1px solid #e4e7ed;
  background-color: #fafafa;
}

.visibility-info h4 {
  margin: 0 0 12px 0;
  font-size: 14px;
  color: #303133;
}

.visibility-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.visibility-option {
  padding: 8px;
  background-color: #ffffff;
  border-radius: 6px;
  border: 1px solid #e4e7ed;
}

.option-desc {
  margin: 4px 0 0 24px;
  font-size: 12px;
  color: #606266;
  line-height: 1.4;
}

/* ф╕нщЧ┤щЭвцЭ┐ - щАЙщб╣цМЙщТо */
.middle-panel {
  padding: 20px;
}

.option-buttons {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.option-btn {
  width: 100%;
  height: 40px;
  font-size: 14px;
  font-weight: 500;
}

/* хП│ф╛зщЭвцЭ┐ - хЖЕхо╣хМ║хЯЯ */
.right-panel {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.content-panel {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.content-panel .panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.query-actions {
  display: flex;
  gap: 8px;
}

/* хЯ║цЬмф┐бцБпхЖЕхо╣ */
.basic-info-content {
  padding: 20px;
  flex: 1;
  overflow-y: auto;
}

.schema-header h2 {
  margin: 0 0 8px 0;
  font-size: 24px;
  font-weight: 600;
  color: #303133;
}

.schema-header .author {
  margin: 0 0 20px 0;
  color: #606266;
  font-size: 14px;
}

.schema-description h4 {
  margin: 0 0 12px 0;
  font-size: 16px;
  font-weight: 600;
  color: #303133;
}

.description-viewer {
  width: 100%;
  height: 300px;
  padding: 0;
  background-color: #ffffff;
  border-radius: 8px;
  border: 1px solid #e4e7ed;
  overflow-y: auto;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
}

.description-viewer.expanded {
  height: 390px; /* цЙйх▒Х30%я╝Ъ300px * 1.3 = 390px */
}

/* цХ░цНох║Уцибх╝ПчК╢цАБ */
.schema-status {
  margin-top: 24px;
}

.schema-status h4 {
  margin: 0 0 12px 0;
  font-size: 16px;
  font-weight: 600;
  color: #303133;
}

.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}

.status-item {
  padding: 12px 16px;
  background-color: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e4e7ed;
}

.status-label {
  font-size: 12px;
  color: #909399;
  margin-bottom: 4px;
}

.status-value {
  font-size: 14px;
  font-weight: 600;
  color: #303133;
}

.status-value.active {
  color: #67c23a;
}

/* цХ░цНох║Уш┐ЮцОеф┐бцБп */
.connection-info {
  margin-top: 24px;
}

.connection-info h4 {
  margin: 0 0 12px 0;
  font-size: 16px;
  font-weight: 600;
  color: #303133;
}

.connection-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}

.connection-item {
  padding: 12px 16px;
  background-color: #f0f9ff;
  border-radius: 8px;
  border: 1px solid #d9ecff;
}

.connection-label {
  font-size: 12px;
  color: #606266;
  margin-bottom: 4px;
}

.connection-value {
  font-size: 14px;
  font-weight: 600;
  color: #303133;
}

.connection-value.connected {
  color: #67c23a;
}

/* цЯешпвщЭвцЭ┐хЖЕхо╣ */
.query-content {
  padding: 20px;
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.sql-editor {
  margin-bottom: 20px;
}

.sql-textarea {
  font-family: 'Courier New', monospace;
}

.results-section {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.results-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.results-header h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #303133;
  display: flex;
  align-items: center;
  gap: 8px;
}

.results-info {
  font-size: 14px;
  color: #606266;
}

.no-results {
  padding: 40px 20px;
  text-align: center;
}

.results-table {
  flex: 1;
  overflow: hidden;
}

.query-table {
  height: 100%;
}

/* хНаф╜НхЖЕхо╣ */
.placeholder-content {
  padding: 40px 20px;
  text-align: center;
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ч╝Цш╛Сцибх╝Пца╖х╝П */
.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.edit-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

.schema-name-input {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 8px;
}

.description-editor {
  margin-top: 16px;
}

.description-pagination {
  margin-top: 16px;
  text-align: center;
}

.edit-config {
  margin-top: 24px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e9ecef;
}

.config-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

.config-item {
  margin-bottom: 16px;
}

.config-item h4 {
  margin: 0 0 8px 0;
  color: #606266;
  font-size: 14px;
  font-weight: 600;
}

.sql-file-upload {
  margin-top: 8px;
}

/* хп╣шпЭцбЖца╖х╝П */
.dialog-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* хУНх║Фх╝Пшо╛шоб */
@media (max-width: 1200px) {
  .schema-wrapper.has-selection {
    grid-template-columns: 200px 160px 1fr;
  }
}

@media (max-width: 768px) {
  .schema-wrapper {
    grid-template-columns: 1fr;
    grid-template-rows: auto;
  }

  .schema-wrapper.has-selection {
    grid-template-columns: 1fr;
    grid-template-rows: auto auto 1fr;
  }

  .nav-buttons {
    display: none;
  }

  .left-panel,
  .middle-panel {
    max-height: 300px;
  }

  .option-buttons {
    flex-direction: row;
    flex-wrap: wrap;
  }

  .option-btn {
    width: calc(50% - 6px);
  }

  .content-panel .panel-header {
    flex-direction: column;
    gap: 12px;
    align-items: stretch;
  }

  .results-header {
    flex-direction: column;
    gap: 8px;
    align-items: flex-start;
  }
}

/* хИЫх╗║цХ░цНох║Уцибх╝Пхп╣шпЭцбЖца╖х╝П */
.create-schema-dialog .el-dialog__body {
  padding: 20px 24px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 16px;
}

.form-col {
  display: flex;
  flex-direction: column;
}

.sql-content-display {
  margin-top: 8px;
}

.sql-content-textarea {
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.4;
}

.sql-content-textarea .el-textarea__inner {
  background-color: #f8f9fa;
  border: 1px solid #e9ecef;
  color: #495057;
}

.html-editor-container {
  border: 1px solid #dcdfe6;
  border-radius: 4px;
  overflow: hidden;
  resize: horizontal;
  min-width: 750px;
  max-width: 100%;
}

.html-editor-header {
  background-color: #f5f7fa;
  border-bottom: 1px solid #dcdfe6;
  padding: 8px 12px;
}

.editor-tabs {
  display: flex;
  gap: 8px;
}

.html-editor-content {
  min-height: 400px;
}

.split-view {
  display: flex;
  height: 100%;
}

.editor-panel.half {
  flex: 2;
  border-right: 1px solid #dcdfe6;
}

.preview-panel.half {
  flex: 1;
  border-right: 1px solid #dcdfe6;
}

.preview-panel.half {
  border-right: none;
  border-left: 1px solid #dcdfe6;
}

.editor-panel.full,
.preview-panel.full {
  width: 100%;
  height: 100%;
}

.panel-title {
  background-color: #f8f9fa;
  padding: 8px 12px;
  border-bottom: 1px solid #e9ecef;
  font-size: 12px;
  font-weight: 600;
  color: #606266;
}

.html-code-editor {
  font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
  font-size: 13px;
  line-height: 1.5;
}

.html-code-editor .el-textarea__inner {
  font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
  font-size: 13px;
  line-height: 1.5;
  border: none;
  border-radius: 0;
  resize: none;
}

.html-preview {
  padding: 12px;
  min-height: 300px;
  background-color: #fff;
  overflow-y: auto;
  border: none;
}

.html-preview h1,
.html-preview h2,
.html-preview h3,
.html-preview h4,
.html-preview h5,
.html-preview h6 {
  margin-top: 0;
  margin-bottom: 16px;
  font-weight: 600;
  line-height: 1.25;
}

.html-preview p {
  margin-bottom: 16px;
  line-height: 1.6;
}

.html-preview ul,
.html-preview ol {
  margin-bottom: 16px;
  padding-left: 24px;
}

.html-preview li {
  margin-bottom: 4px;
}

.html-preview code {
  background-color: #f6f8fa;
  border-radius: 3px;
  font-size: 85%;
  margin: 0;
  padding: 0.2em 0.4em;
}

.html-preview pre {
  background-color: #f6f8fa;
  border-radius: 6px;
  font-size: 85%;
  line-height: 1.45;
  overflow: auto;
  padding: 16px;
  margin-bottom: 16px;
}

.html-editor-container .ql-toolbar {
  border-bottom: 1px solid #dcdfe6;
  background-color: #fafafa;
}

.html-editor-container .ql-container {
  border: none;
  font-size: 14px;
}

.sql-file-upload .el-upload-dragger {
  width: 100%;
  height: 120px;
  border: 2px dashed #d9d9d9;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: border-color 0.3s;
}

.sql-file-upload .el-upload-dragger:hover {
  border-color: #409eff;
}

.sql-file-upload .el-upload-dragger .el-icon--upload {
  font-size: 28px;
  color: #8c939d;
  margin-bottom: 16px;
}

.sql-file-upload .el-upload__text {
  color: #606266;
  font-size: 14px;
  text-align: center;
}

.sql-file-upload .el-upload__tip {
  font-size: 12px;
  color: #909399;
  margin-top: 7px;
}

@media (max-width: 768px) {
  .create-schema-dialog {
    width: 95% !important;
  }

  .form-row {
    grid-template-columns: 1fr;
    gap: 12px;
  }
}
</style>
